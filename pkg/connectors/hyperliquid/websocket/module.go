package websocket

import (
	"context"
	"net/http"
	"time"

	"github.com/backtesting-org/kronos-sdk/pkg/types/logging"
	"github.com/backtesting-org/kronos-sdk/pkg/types/temporal"
	"github.com/backtesting-org/live-trading/pkg/websocket/base"
	"github.com/backtesting-org/live-trading/pkg/websocket/connection"
	"github.com/backtesting-org/live-trading/pkg/websocket/performance"
	"github.com/backtesting-org/live-trading/pkg/websocket/security"
	"go.uber.org/fx"
)

// noOpAuthProvider is a no-op implementation for public WebSocket channels
type noOpAuthProvider struct{}

func (n *noOpAuthProvider) GetAuthHeaders(_ context.Context) (http.Header, error) {
	return make(http.Header), nil
}

func (n *noOpAuthProvider) IsAuthenticated() bool {
	return true
}

func (n *noOpAuthProvider) Refresh(_ context.Context) error {
	return nil
}

func (n *noOpAuthProvider) GetTokenExpiry() time.Time {
	return time.Now().Add(24 * time.Hour)
}

// NewAuthManager creates auth manager (no-op for public channels)
func NewAuthManager(logger logging.ApplicationLogger) security.AuthManager {
	authProvider := &noOpAuthProvider{}
	return security.NewAuthManager(authProvider, logger)
}

// NewValidationConfig creates validation configuration
func NewValidationConfig() security.ValidationConfig {
	return security.ValidationConfig{
		MaxMessageSize: 65536,
		AllowedTypes: map[string]bool{
			"l2Book":   true,
			"trades":   true,
			"candle":   true,
			"webData2": true,
		},
		TypeField: "channel",
	}
}

// NewMessageValidator creates message validator
func NewMessageValidator(valConfig security.ValidationConfig) security.MessageValidator {
	return security.NewMessageValidator(valConfig)
}

// NewRateLimiter creates rate limiter
func NewRateLimiter() security.RateLimiter {
	return security.NewRateLimiter(1000, 100)
}

// NewMetrics creates metrics instance
func NewMetrics() performance.Metrics {
	return performance.NewMetrics()
}

// NewCircuitBreaker creates circuit breaker
func NewCircuitBreaker() performance.CircuitBreaker {
	return performance.NewCircuitBreaker(3, 30*time.Second)
}

// NewMessageParser creates message parser
func NewMessageParser(
	logger logging.ApplicationLogger,
	timeProvider temporal.TimeProvider,
) MessageParser {
	return NewParser(logger, timeProvider)
}

// NewConnectionConfig creates connection configuration
func NewConnectionConfig() connection.Config {
	cfg := connection.DefaultConfig()
	cfg.URL = "wss://api.hyperliquid.xyz/ws"
	cfg.EnableHealthMonitoring = true
	cfg.EnableHealthPings = true
	cfg.HealthCheckInterval = 30 * time.Second
	return cfg
}

// NewConnectionManager creates connection manager
func NewConnectionManager(
	config connection.Config,
	authManager security.AuthManager,
	metrics performance.Metrics,
	logger logging.ApplicationLogger,
) connection.ConnectionManager {
	return connection.NewConnectionManager(config, authManager, metrics, logger)
}

// NewReconnectionStrategy creates reconnection strategy
func NewReconnectionStrategy() connection.ReconnectionStrategy {
	return connection.NewExponentialBackoffStrategy(
		5*time.Second,
		60*time.Second,
		10,
	)
}

// NewReconnectManager creates reconnect manager
func NewReconnectManager(
	connManager connection.ConnectionManager,
	strategy connection.ReconnectionStrategy,
	logger logging.ApplicationLogger,
) connection.ReconnectManager {
	return connection.NewReconnectManager(connManager, strategy, logger)
}

// NewBaseServiceConfig creates base service configuration
func NewBaseServiceConfig() base.Config {
	return base.Config{
		URL:            "wss://api.hyperliquid.xyz/ws",
		ReconnectDelay: 5 * time.Second,
		MaxReconnects:  10,
		PingInterval:   30 * time.Second,
		PongTimeout:    10 * time.Second,
		MaxMessageSize: 65536,
	}
}

// NewBaseService creates base service
func NewBaseService(
	config base.Config,
	logger logging.ApplicationLogger,
	validator security.MessageValidator,
	rateLimiter security.RateLimiter,
	metrics performance.Metrics,
	circuitBreaker performance.CircuitBreaker,
) base.BaseService {
	return base.NewBaseService(
		config,
		logger,
		validator,
		rateLimiter,
		metrics,
		circuitBreaker,
	)
}

// WebSocketModule provides all real-time WebSocket dependencies
var WebSocketModule = fx.Module("hyperliquid_websocket",
	fx.Provide(
		fx.Annotate(
			NewAuthManager,
			fx.ResultTags(`name:"hyperliquid_auth_manager"`),
		),
		fx.Annotate(
			NewValidationConfig,
			fx.ResultTags(`name:"hyperliquid_validation"`),
		),
		fx.Annotate(
			NewMessageValidator,
			fx.ParamTags(`name:"hyperliquid_validation"`),
			fx.ResultTags(`name:"hyperliquid_validator"`),
		),
		fx.Annotate(
			NewRateLimiter,
			fx.ResultTags(`name:"hyperliquid_rate_limiter"`),
		),
		fx.Annotate(
			NewMetrics,
			fx.ResultTags(`name:"hyperliquid_metrics"`),
		),
		fx.Annotate(
			NewCircuitBreaker,
			fx.ResultTags(`name:"hyperliquid_circuit_breaker"`),
		),
		fx.Annotate(
			NewMessageParser,
			fx.ResultTags(`name:"hyperliquid_parser"`),
		),
		fx.Annotate(
			NewConnectionConfig,
			fx.ResultTags(`name:"hyperliquid_connection_config"`),
		),
		fx.Annotate(
			NewConnectionManager,
			fx.ParamTags(
				`name:"hyperliquid_connection_config"`,
				`name:"hyperliquid_auth_manager"`,
				`name:"hyperliquid_metrics"`,
			),
			fx.ResultTags(`name:"hyperliquid_connection_manager"`),
		),
		fx.Annotate(
			NewReconnectionStrategy,
			fx.ResultTags(`name:"hyperliquid_strategy"`),
		),
		fx.Annotate(
			NewReconnectManager,
			fx.ParamTags(
				`name:"hyperliquid_connection_manager"`,
				`name:"hyperliquid_strategy"`,
			),
			fx.ResultTags(`name:"hyperliquid_reconnect_manager"`),
		),
		fx.Annotate(
			NewBaseServiceConfig,
			fx.ResultTags(`name:"hyperliquid_base_config"`),
		),
		fx.Annotate(
			NewBaseService,
			fx.ParamTags(
				`name:"hyperliquid_base_config"`,
				``,
				`name:"hyperliquid_validator"`,
				`name:"hyperliquid_rate_limiter"`,
				`name:"hyperliquid_metrics"`,
				`name:"hyperliquid_circuit_breaker"`,
			),
			fx.ResultTags(`name:"hyperliquid_base"`),
		),
		fx.Annotate(
			NewWebSocketService,
			fx.ParamTags(
				`name:"hyperliquid_connection_manager"`,
				`name:"hyperliquid_reconnect_manager"`,
				`name:"hyperliquid_base"`,
				``,
				`name:"hyperliquid_parser"`,
			),
		),
	),
)
